# WhatsApp Business Chatbot

A modular, customizable WhatsApp chatbot designed for small and medium-sized businesses (SMBs) that need reliable, low-cost automated customer interaction. The system is powered by Large Language Models (LLMs) and structured to support future model switching and feature expansion without major rewrites.

---

## Overview

The chatbot integrates with the WhatsApp Business Cloud API to receive and respond to customer messages in real time via webhook events. The backend is built with FastAPI and follows a clean, modular structure where HTTP endpoints, routers, and business logic are separated for maintainability and extensibility.

In addition to LLM-based responses, the project now includes a knowledge base (RAG) pipeline using ChromaDB, caching for cost/performance, message deduplication, and persistence via Postgres for auditability and reliability.

---

## Key Features

### LLM-Powered Responses
- Natural, context-aware replies generated by an OpenAI chat model.
- Prompt templates are configurable for different response modes (with/without retrieved context).

### Retrieval-Augmented Generation (RAG) Knowledge Base
- Uses a vector database (ChromaDB) to retrieve relevant business knowledge and ground responses.
- Supports initializing/rebuilding the vector database from a project text file.
- Retrieved context is inserted into prompts to reduce hallucinations and improve factual accuracy.

### Knowledge Base Caching (Cost and Latency Reduction)
- Per-user caching for retrieved knowledge context (reduces repeated embedding + retrieval calls).
- Cache versioning allows invalidation when the knowledge base changes.
- Debug endpoints available to test cache hit/miss behavior.

### Postgres Persistence (Messages and Idempotency)
- Logs inbound and outbound messages to Postgres for tracking and debugging.
- Idempotency via message ID claiming to prevent duplicate processing (important for webhook retries).
- Designed to handle Meta retries without double-sending responses.

### Deduplication Layer
- Memory-based short-window deduplication to reject repeated inbound WhatsApp message IDs.
- Works alongside DB idempotency for stronger reliability.

### Admin Knowledge Base Management
- Admin commands (WhatsApp-side) to manage KB entries:
  - `/add <text>` adds content to the KB
  - `/del <id>` deletes by exact document ID
  - `/list` lists KB entries (use cautiously as KB grows)
- Admin actions are logged to a file for auditability.

### Tool Routing for Simple Business Logic
- Lightweight tool-call routing for deterministic logic such as “Are you open now?”
- Calls a local business-hours function when relevant; otherwise falls back to normal LLM response flow.

### Modular FastAPI Architecture
- `main.py` is kept as the application boundary:
  - app startup/lifespan
  - router wiring
  - webhook endpoints (fast ACK)
- Routers for admin/debug endpoints are split into separate modules.
- Core logic lives in `services/` for clarity and testability.

### Debug and Ops Endpoints
- `/debug/cache_test` validates retrieval + cache behavior (hit/miss, timings, context length).
- `/debug/routes` lists registered routes safely.
- Admin-only debug endpoints (guarded via headers) for cache and KB inspection.

---

## How It Works

1. Customers send a message to the business’s WhatsApp number.
2. WhatsApp forwards the message to the webhook endpoint.
3. The backend ACKs quickly and processes the message in a background task.
4. The system:
   - checks idempotency/deduplication
   - logs inbound message to Postgres
   - routes tool calls when needed (e.g., open/closed queries)
   - retrieves knowledge base context (cached when possible)
   - generates a response using the LLM
   - logs outbound response to Postgres
5. The chatbot sends the response back through the WhatsApp Cloud API.

---

## Tech Stack

- Python 3
- FastAPI (webhook server)
- WhatsApp Business Cloud API
- OpenAI LLMs (chat + embeddings)
- ChromaDB (vector database for RAG)
- Postgres (message logging + idempotency)
- ngrok (local development tunnelling)

---

## Project Structure (High Level)

- `app/main.py`  
  Application entrypoint (startup + router wiring + webhook endpoints)

- `app/routers/`  
  API route modules (admin, debug, frontend)

- `app/services/`  
  Business logic modules (webhook handler, KB cache, KB init, Chroma store, WhatsApp client, dedup, admin KB ops)

- `app/db/`  
  Postgres connection + repositories for message persistence and idempotency

- `Knowledge_Base/`  
  Project knowledge source text + persisted vector DB storage

- `frontend/`  
  Simple frontend assets (served via static mount)

---

## To-Do List (Next Improvements)

1. Fallback replies on failures  
   - If WhatsApp API or OpenAI requests fail, send a friendly fallback message.
   - Add structured error handling and retry rules where appropriate.

2. Implement calendar bookings
   - Allow for natural language booking
   - To be tied with Google Calendar API (for proof of concept)

3. Production hardening  
   - Move config into a centralized settings layer.
   - Add deployment docs (Railway/Docker) and health checks.

---

## Status

This project is under active development and intended for future deployment to production environments.
